pipeline {
    agent {
        dockerfile { dir 'build-pipe/docker/ubuntu_14_04_x86_64' }
    }
    stages {
        stage('Build') {
            environment {
              SAPMACHINE_GIT_REPO = 'github.com/SAP/SapMachine.git'
              SAPMACHINE_GIT_BRANCH = 'sapmachine'
              SAPMACHINE_ARCHIVE_NAME_PREFIX = 'sapmachine_linux-x64'
              SAPMACHINE_PUBLISH_GITHUB_TOKEN = credentials('SapMachine-Github-Token')
              SAPMACHINE_PUBLISH_GITHUB_REPO_NAME = 'SapMachine'
              SAPMACHINE_PUBLISH_GITHUB_USER = 'SAP'
            }
            steps {
              withCredentials([
                  [$class: 'UsernamePasswordMultiBinding', credentialsId: 'SapMachine-github', usernameVariable: 'GIT_USER', passwordVariable: 'GIT_PASSWORD']
                  ]) {
                sh '''
                  build-pipe/build.sh
                  '''
                }
            }
            post {
                success {
                    junit 'gtest.xml'
                }
            }
        }
        stage('Publish') {
            when {
                expression { params.PUBLISH == true }
            }
            environment {
              SAPMACHINE_GIT_REPO = 'github.com/SAP/SapMachine.git'
              SAPMACHINE_GIT_BRANCH = 'sapmachine'
              SAPMACHINE_ARCHIVE_NAME_PREFIX = 'sapmachine_linux-x64'
              SAPMACHINE_PUBLISH_GITHUB_TOKEN = credentials('SapMachine-Github-Token')
              SAPMACHINE_PUBLISH_GITHUB_REPO_NAME = 'SapMachine'
              SAPMACHINE_PUBLISH_GITHUB_USER = 'SAP'
            }
            steps {
                sh '''
                build-pipe/publish.sh
                '''
            }
        }
        stage('Archive') {
            steps {
                archive 'build.tar.gz'
            }
        }
        stage('Trigger Tests') {
            when {
                expression { params.RUN_TESTS == true }
            }
            steps {
            build job: 'test-pipeline-jtreg-hotspot', propagate: false, wait: false, parameters:
                [
                    string(name: 'GIT_TAG_NAME', value: GIT_TAG_NAME),
                    string(name: 'test_suite', value: 'hotspot'),
                    string(name: 'test_groups', value: ':hotspot_tier1')
                ]

            build job: 'test-pipeline-jtreg-jdk', propagate: false, wait: false, parameters:
                [
                    string(name: 'GIT_TAG_NAME', value: GIT_TAG_NAME),
                    string(name: 'test_suite', value: 'jdk'),
                    string(name: 'test_groups', value: ':tier1')
                ]

            build job: 'test-pipeline-jtreg-langtools', propagate: false, wait: false, parameters:
                [
                    string(name: 'GIT_TAG_NAME', value: GIT_TAG_NAME),
                    string(name: 'test_suite', value: 'langtools'),
                    string(name: 'test_groups', value: 'jdk tools lib')
                ]
            }
        }
    }
}
